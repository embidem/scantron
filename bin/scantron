#!/usr/bin/env ruby

require 'optparse'

require "scantron/inventory"
require "scantron/lsof_parser"
require "scantron/rpcinfo_parser"
require "scantron/scanner"

options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: scantron [options]"

  opts.on("-n", "--nmap-results RESULTS", "path to XML nmap results file") do |n|
    options[:nmap_results] = n
  end

  opts.on("-i", "--inventory INVENTORY", "path to an inventory file") do |i|
    options[:inventory] = i
  end
end.parse!

unless options.has_key?(:nmap_results)
  warn "--nmap-results required"
  exit 1
end

unless options.has_key?(:inventory)
  warn "--inventory required"
  exit 1
end

lsof_parser = Scantron::LsofParser.new
rpcinfo_parser = Scantron::RPCInfoParser.new

inventory = Scantron::Inventory.new(options.fetch(:inventory))
results = Nmap::XML.new(options.fetch(:nmap_results))
scanner = Scantron::Scanner.new(results, lsof_parser, rpcinfo_parser)

puts ["IP Address", "Job", "Service", "Port", "SSL"].join("\t")

inventory.each_host do |machine|
  begin
    results = scanner.scan(machine)
  rescue Scantron::UnknownMachine
    puts [machine.address, machine.type, "-", "-", "-"].join("\t")
    next
  end

  results.each { |r| puts [machine.address, machine.type, r.service, r.port, "#{'âœ“' if r.ssl?}"].join("\t") }
end

